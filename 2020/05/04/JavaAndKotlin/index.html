
<!DOCTYPE html>
<html lang="en" class="loading">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>开发效率 - Kotlin - Lollipop</title>
    <meta name="baidu-site-verification" content="lGVNqFPfNO" />
    <meta name="google-site-verification" content="sm3JfidSJFBpLMJ5iPEwXzBiGID7DzfiKlJaktGdgIo" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="google" content="notranslate" />
    <meta name="keywords" content="Lollipop,"> 
    <meta name="description" content="A simple blog site,日常工作中，我们总是希望提高效率，比如快捷键、自动化等，其实开发语言本身在兼容的情况下，也是可以提高效率的。比如Java的lambda表达式。这里介绍的Kotlin，并不是为了介绍Kotlin语言的,"> 
    <meta name="author" content="Lollipop"> 
    <link rel="alternative" href="atom.xml" title="Lollipop" type="application/atom+xml"> 
    <link rel="icon" href="/img/favicon.png"> 
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
    <link rel="stylesheet" href="/css/diaspora.css">
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
         (adsbygoogle = window.adsbygoogle || []).push({
              google_ad_client: "ca-pub-8691406134231910",
              enable_page_level_ads: true
         });
    </script>
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
</head>

<body class="loading">
    <span id="config-title" style="display:none">Lollipop</span>
    <div id="loader"></div>
    <div id="single">
    <div id="top" style="display: block;">
    <div class="bar" style="width: 0;"></div>
    <a class="icon-home image-icon" href="javascript:;" target="_blank" rel="noopener" data-url="http://lollipoppp.com"></a>
    <div title="播放/暂停" class="icon-play"></div>
    <h3 class="subtitle">开发效率 - Kotlin</h3>
    <div class="social">
        <!--<div class="like-icon">-->
            <!--<a href="javascript:;" target="_blank" rel="noopener" class="likeThis active"><span class="icon-like"></span><span class="count">76</span></a>-->
        <!--</div>-->
        <div>
            <div class="share">
                <a title="获取二维码" class="icon-scan" href="javascript:;" target="_blank" rel="noopener"></a>
            </div>
            <div id="qr"></div>
        </div>
    </div>
    <div class="scrollbar"></div>
</div>

    <div class="section">
        <div class="article">
    <div class='main'>
        <h1 class="title">开发效率 - Kotlin</h1>
        <div class="stuff">
            <span>五月 04, 2020</span>
            
  <ul class="post-tags-list" itemprop="keywords"><li class="post-tags-list-item"><a class="post-tags-list-link" href="/tags/%E2%80%9CAndroid%E2%80%9D/" rel="tag">“Android”</a></li></ul>


        </div>
        <div class="content markdown">
            <p>日常工作中，我们总是希望提高效率，比如快捷键、自动化等，其实开发语言本身在兼容的情况下，也是可以提高效率的。比如<code>Java</code>的<code>lambda表达式</code>。<br>这里介绍的<code>Kotlin</code>，并不是为了介绍<code>Kotlin</code>语言的入门或者使用方式，而是和<code>Java</code>对比，说明<code>Kotlin</code>提高效率的方面，下面会用一些小例子，说明一下日常开发中的小提升。</p>
<h2 id="兼容性"><a href="#兼容性" class="headerlink" title="兼容性"></a>兼容性</h2><h3 id="版本"><a href="#版本" class="headerlink" title="版本"></a>版本</h3><p><code>Kotlin</code>会被编译为<code>Java</code>字节码，并且可以指定<code>Java</code>版本，这样一来，对于需要运行指定版本<code>Java</code>代码的环境来说，就非常友好了。</p>
<h3 id="双向"><a href="#双向" class="headerlink" title="双向"></a>双向</h3><p>在<code>Kotlin</code>的代码中是可以直接调用<code>Java</code>类的方法的，因此对于老项目改造是很友好的。<br>而<code>Java</code>中也可以直接使用<code>Kotlin</code>的类以及方法，虽然使用的时候看起来有点奇怪，但是还是可以直接兼容的，因此对于老项目的升级，是没有问题的。</p>
<h2 id="类型处理"><a href="#类型处理" class="headerlink" title="类型处理"></a>类型处理</h2><h3 id="类型推导"><a href="#类型推导" class="headerlink" title="类型推导"></a>类型推导</h3><p>在<code>Kotlin</code>中，申明变量是这样的：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> sdf = SimpleDateFormat(<span class="string">""</span>)</span><br><span class="line"><span class="keyword">var</span> sdf2 = SimpleDateFormat(<span class="string">""</span>)</span><br></pre></td></tr></table></figure>
<p>可以看到，前面就一个<code>val</code>或者<code>var</code>，看起来像是<code>JavaScript</code>的弱类型啊，其实并不是。<br><strong>当申明变量并且直接初始化为明确类型的值时，可以自动推导类型，不用指定类型。</strong><br>换句话说，有下面的情况</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 申明一个Int值</span></span><br><span class="line"><span class="keyword">var</span> index = <span class="number">0</span></span><br><span class="line"><span class="comment">// 申明一个Lang值</span></span><br><span class="line"><span class="keyword">var</span> time = <span class="number">0L</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 这样写就不行啦，因为变量的申明，要么可以推导确定类型，要么指定类型</span></span><br><span class="line"><span class="keyword">var</span> temp = <span class="literal">null</span></span><br><span class="line"><span class="comment">// 可以改成这样</span></span><br><span class="line"><span class="keyword">var</span> temp: String? = <span class="literal">null</span></span><br></pre></td></tr></table></figure>

<p>你可能会说，这个好像也没多大区别吧，但是对于下面这两种场景呢？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SimpleDateFormat sdf = <span class="keyword">new</span> SimpleDateFormat(<span class="string">""</span>);</span><br><span class="line"></span><br><span class="line">MainFragment.LoadCallback loadCallback = <span class="keyword">new</span> MainFragment.LoadCallback() &#123; ... &#125;;</span><br><span class="line"></span><br><span class="line">OutputStream out = xxx.getOutputStream();</span><br></pre></td></tr></table></figure>
<p>这时候就很不友好了，每次接受一个对象需要写一遍类型再写名字。如果同样的内容换成<code>kotlin</code>呢?</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> sdf = SimpleDateFormat(<span class="string">""</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> loadCallback = <span class="keyword">object</span>: MainFragment.LoadCallback() &#123; ... &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> <span class="keyword">out</span> = xxx.getOutputStream();</span><br></pre></td></tr></table></figure>
<p>这样是不是就友好很多？<br>尽管编译器的<code>.var</code>快捷命令，可以帮助我们申明类型，但是它代码本身就在那里，还是会影响视觉。</p>
<blockquote>
<p><code>val</code>及<code>var</code>的区别请前往中文官网自行查看。<br>另外，<code>Java</code>高版本也支持了类型推导，但是个人认为没有<code>Kotlin</code>做得好，而且有版本兼容问题。</p>
</blockquote>
<hr>
<h3 id="非空判断"><a href="#非空判断" class="headerlink" title="非空判断"></a>非空判断</h3><p><code>Java</code>中写的最多的，可能就是判空吧。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 方法调用</span></span><br><span class="line"><span class="keyword">if</span> (a != <span class="keyword">null</span>) &#123;</span><br><span class="line">    a.b();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 变量赋值</span></span><br><span class="line">String b = <span class="string">""</span>;</span><br><span class="line"><span class="keyword">if</span> (c != <span class="keyword">null</span>) &#123;</span><br><span class="line">    b = c.d();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在好消息是，<code>Kotlin</code>里面可以大幅度的省略这部分代码了！<br>这分为两部分：类型非空，空判定</p>
<h4 id="类型非空"><a href="#类型非空" class="headerlink" title="类型非空"></a>类型非空</h4><p>上一个小节里面，指定变量类型的时候，在类型名称后面加上了一个<code>?</code>，就像这样：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> temp: String? = <span class="literal">null</span></span><br></pre></td></tr></table></figure>
<p>这就是类型非空了，当一个变量申明时，如果变量类型后面携带了<code>?</code>，或者类型推导时发现内容可能为<code>null</code>，那么就会在调用时直接报错或者发出警告。提示你对象可能为<code>null</code>，怎么调用这些可能为null的对象，是下一个标题的内容。<br>相反的，如果申明时没有携带<code>?</code>，那么它就认为这个变量是不能赋值为<code>null</code>的，如果你在后续的赋值中，赋值了<code>null</code>，就会自己报错，连编译都过不了，就算侥幸<code>骗过</code>了编译，也会在运行时赋值为<code>null</code>的时候直接报错。<br>这样可以一定程度上避免代码单元内的空指针问题，也可以一定程度尽早发现空指针问题，同样，也少了很多的非空判断</p>
<h4 id="空判定"><a href="#空判定" class="headerlink" title="空判定"></a>空判定</h4><p>上面说的是类型指定，那么使用呢？如果一个可能为<code>null</code>的对象怎么使用？加<code>if</code>？不用，可以直接这样写：（沿用小节开头的<code>Java</code>例子）</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 方法调用</span></span><br><span class="line">a?.b();</span><br><span class="line"><span class="comment">// 变量赋值</span></span><br><span class="line"><span class="keyword">val</span> b = c?.d()?:<span class="string">""</span>;</span><br><span class="line"><span class="comment">// 参数判断</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">test</span><span class="params">(a: <span class="type">A</span>?)</span></span> &#123;</span><br><span class="line">    a?:<span class="keyword">return</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面列举了三种常见的场景。<br>对于对象的方法调用，直接加上一个<code>?</code>即可，等价于上面的<code>if</code>中调用。<br>对于参数的赋值，可以在后面添加默认值，使用的是<code>?:</code>。<br>对于方法内的参数判断，可以直接使用像是赋值一样的写法，然后执行<code>return</code>操作。<br>代码是不是就简单了很多？</p>
<h2 id="Getter-amp-Setter"><a href="#Getter-amp-Setter" class="headerlink" title="Getter &amp; Setter"></a>Getter &amp; Setter</h2><p><code>Kotlin</code>帮我们做了很多的默认实现，这让我们的代码写起来更加轻松。<br>按照Java规范，我们写一个数据类一般是这样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Bean</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String a;</span><br><span class="line">    <span class="keyword">private</span> String b;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> c;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Bean</span><span class="params">(String a, String b, String c)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.a = a;</span><br><span class="line">        <span class="keyword">this</span>.b = b;</span><br><span class="line">        <span class="keyword">this</span>.c = c;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Bean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(<span class="string">""</span>, <span class="string">""</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getA</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> a;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getB</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> b;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getC</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> c;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setA</span><span class="params">(String a)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.a = a;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setC</span><span class="params">(<span class="keyword">int</span> c)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.c = c;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 省略toString及equals方法的重写</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，尽管只有三个成员变量，但是一个类还是非常的长，尽管有编译器的一键生成，但是代码仍然很多，不是很友好，而且全都是非常机械非常模板化的代码。那么在<code>Kotlin</code>中会是什么效果，简化会达到什么程度呢？</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">data</span> <span class="class"><span class="keyword">class</span> <span class="title">Bean</span></span>(<span class="keyword">var</span> a: String = <span class="string">""</span>, <span class="keyword">val</span> b: String = <span class="string">""</span>, <span class="keyword">var</span> c: <span class="built_in">Int</span> = <span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<p>是不是感觉有点离谱？这里可以告诉你的是：确实已经写完了一个<code>Bean</code>。那么它符合<code>Java</code>规范吗？它是符合的，只是简化了这个过程，class的前面加上了<code>data</code>，表示这是一个数据类，<code>Kotlin</code>会自动为我们根据成员变量生成<code>toString</code>和<code>equals</code>等方法，我们也可以选择重写它，如果不需要特别重写，那么我们连类的大括号都不用写。<br>上面的<code>Java</code>代码中，<code>b</code>是不能被赋值的，这里只要把<code>var</code>改成<code>val</code>就好了。而<code>getter</code>和<code>setter</code>呢?<br><code>Kotlin</code>中的每个变量都默认有个<code>getter</code>和<code>setter</code>的实现，也就是都帮我们写好了默认实现。<br>而成员变量的申明，因为变量会在构造器赋值，所以只要在构造器的参数中加上变量前缀，就自动变成了成员变量，当然，还可以前缀一个<code>private</code>，让这个变量只能内部可见。<br>那么又有另一个问题了，三个参数都有默认值，我只想设定其中两个怎么办？<code>Java</code>上的做法就只有提供足够多的重载了，但是<code>Kotlin</code>里面可以这样写：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">test</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> bean = Bean(a = <span class="string">"hello"</span>, c = <span class="number">2</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>是的，还可以直接使用变量名指定传值，这样连重载也不用了。<br>但是这里要说明一点，如果是需要反射调用的方法或者构造器，是需要单独申明的，否则是找不到的，毕竟参数数量本身没有变。</p>
<p>另一个方面，上面说了，<code>Kotlin</code>帮我们写好了<code>getter</code>和<code>setter</code>，那么我们能重写吗？请看下面的例子:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> colorArray = intArrayOf(Color.RED, Color.GREEN, Color.BLUE)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> index = <span class="number">0</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> color: <span class="built_in">Int</span></span><br><span class="line">        <span class="keyword">get</span>() &#123;</span><br><span class="line">            <span class="keyword">return</span> colorArray[index]</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span>(value) &#123;</span><br><span class="line">            colorArray[index] = value</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">next</span><span class="params">()</span></span> &#123;</span><br><span class="line">        index++</span><br><span class="line">        index %= colorArray.size</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">test</span><span class="params">(a: <span class="type">A</span>)</span></span> &#123;</span><br><span class="line">    <span class="comment">// 就像直接普通变量一样使用，完全感知不到getter方法</span></span><br><span class="line">    <span class="keyword">val</span> index = a.index</span><br><span class="line">    <span class="comment">// 报错，提示找不到设置的方法</span></span><br><span class="line">    <span class="comment">// a.index = 1</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 就像常规变量一样获取</span></span><br><span class="line">    <span class="keyword">val</span> color = a.color</span><br><span class="line">    <span class="comment">// 直接对变量赋值，其实是走到了setter方法</span></span><br><span class="line">    a.color = Color.PINK</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，我们的<code>A</code>中维护了一个颜色数组，提供了一个方法来移动下标。<br>外部可以拿到下标，也可以通过一个叫<code>color</code>的变量来获取和设置当前下标对应的颜色。但是我们其实没有<code>color</code>这个成员变量，我们只是通过完全重写<code>getter</code>和<code>setter</code>来模拟了一个变量。</p>
<h2 id="扩展方法"><a href="#扩展方法" class="headerlink" title="扩展方法"></a>扩展方法</h2><p>都说<code>Kotlin</code>是语法糖，但是这糖也是真的甜。比如这里介绍的<code>扩展方法</code>。<br>它其实不是真的为对象类型增加了方法，只是从语法上做到了效果而已，但是使用的时候却可以大大提升效率。<br>举个<code>Java</code>的例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将一个int转换为字符串的方法</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">formatInt</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (i &lt; <span class="number">10</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"0"</span> + i;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">""</span> + i;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">funA</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String str = formatInt(</span><br><span class="line">            object1.funB(</span><br><span class="line">                object2.funC())</span><br><span class="line">            .funD());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这是一个很简单的例子，但是看起来就不是很友好了，业务场景可能还会有更麻烦的结构。你可能会说多申明几个变量，然后分开写，但是那样又会显得很臃肿，写起来没有这种链条一样调用的爽快感觉。<br>所以可以这么写:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将一个int转换为字符串的方法</span></span><br><span class="line"><span class="keyword">private</span> fun Int.format(): String &#123;</span><br><span class="line">    <span class="keyword">if</span> (i &lt; <span class="number">10</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"0$i"</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"$i"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> fun <span class="title">funA</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    val str = object1.funB(object2.funC())</span><br><span class="line">                        .funD()</span><br><span class="line">                        .format()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个扩展方法就像它原本就有的方法一样，可以直接调用，完美的混入了<code>链条</code>中。<br>而使用是，方法的增加和去掉，也不用像以前一样，考虑左边括号到哪里，右边括号是哪一个了。</p>
<h2 id="函数式编程"><a href="#函数式编程" class="headerlink" title="函数式编程"></a>函数式编程</h2><p><code>Java</code>中是先有<code>Class</code>再有方法，也就是必须要有对象。而在<code>Kotlin</code>中，也是面向对象，但是它可以有顶级函数，也就是不依托于<code>Class</code>的函数，当然，这也是语法糖而已。但是使用效果非常不错，我们先举例子再说明：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TaskUtil</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Executor threadPool = Executors.newCachedThreadPool();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Handler mainHandler = <span class="keyword">new</span> Handler(Looper.getMainLooper());</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">doAsync</span><span class="params">(ErrorCallback err, RunCallback run)</span> </span>&#123;</span><br><span class="line">        threadPool.execute(<span class="keyword">new</span> Task(err, run));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">onUI</span><span class="params">(ErrorCallback err, RunCallback run)</span> </span>&#123;</span><br><span class="line">        mainHandler.post(<span class="keyword">new</span> Task(err, run));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Task</span> <span class="keyword">extends</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">private</span> ErrorCallback errorCallback;</span><br><span class="line">        <span class="keyword">private</span> RunCallback runCallback;</span><br><span class="line">    </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Task</span><span class="params">(ErrorCallback e, RunCallback r)</span> </span>&#123;</span><br><span class="line">            errorCallback = e;</span><br><span class="line">            runCallback = r;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                runCallback.run();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (e: Throwable) &#123;</span><br><span class="line">                <span class="keyword">if</span> (errorCallback != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    errorCallback.onError(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">ErrorCallback</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">RunCallback</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">final</span> String str = <span class="string">""</span>;</span><br><span class="line">                </span><br><span class="line">        TaskUtil.doAsync(<span class="keyword">null</span>, <span class="keyword">new</span> TaskUtil.RunCallback() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="comment">// 子线程</span></span><br><span class="line">                ...</span><br><span class="line">                Test.<span class="keyword">this</span>.testB(str);</span><br><span class="line">                TaskUtil.onUI(<span class="keyword">null</span>, <span class="keyword">new</span> TaskUtil.RunCallback() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        ...</span><br><span class="line">                        <span class="comment">// UI线程</span></span><br><span class="line">                        Test.<span class="keyword">this</span>.testB(str);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testB</span><span class="params">(String str)</span> </span>&#123;&#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面是一个简单的线程同步的工具类以及调用示例，可以看到，尽管简化了一部分代码，但是使用时的调用仍然非常繁琐，而且会存在上下文问题（回调函数中的<code>this</code>到底是哪个<code>this</code>?。那么<code>Kotlin</code>里面呢？</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> threadPool: Executor <span class="keyword">by</span> lazy &#123;</span><br><span class="line">    Executors.newCachedThreadPool()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> mainHandler: Handler <span class="keyword">by</span> lazy &#123;</span><br><span class="line">    Handler(Looper.getMainLooper())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;<span class="keyword">reified</span> T: Any&gt;</span> T.<span class="title">doAsync</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">noinline</span> err: ((<span class="type">Throwable</span>) -&gt; <span class="type">Unit</span>)? = <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">noinline</span> run: <span class="type">T</span>.() -&gt; <span class="type">Unit</span>)</span></span> &#123;</span><br><span class="line">    threadPool.execute &#123; </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            run.invoke(<span class="keyword">this</span>)</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e: Throwable) &#123;</span><br><span class="line">            err?.invoke(e)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;<span class="keyword">reified</span> T: Any&gt;</span> T.<span class="title">onUI</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">noinline</span> err: ((<span class="type">Throwable</span>) -&gt; <span class="type">Unit</span>)? = <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">noinline</span> run: <span class="type">T</span>.() -&gt; <span class="type">Unit</span>)</span></span> &#123;</span><br><span class="line">    mainHandler.post &#123; </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            run.invoke(<span class="keyword">this</span>)</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e: Throwable) &#123;</span><br><span class="line">            err?.invoke(e)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">test</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> str = <span class="string">""</span></span><br><span class="line">        doAsync &#123;</span><br><span class="line">            <span class="comment">// 子线程中</span></span><br><span class="line">            testB(str)</span><br><span class="line">            onUI &#123;</span><br><span class="line">                <span class="comment">// UI线程中</span></span><br><span class="line">                testB(str)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">testB</span><span class="params">(str: <span class="type">String</span>)</span></span> &#123;&#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，对比效果非常明显。<strong>调用简单</strong>而且<strong>结构清晰</strong>。<br>那么，现在来说解释一下，上面用到了哪些东西。</p>
<h3 id="顶级函数"><a href="#顶级函数" class="headerlink" title="顶级函数"></a>顶级函数</h3><p>顶级函数，也就是前面方法申明的时候，外面没有套一层<code>Class</code>，减少了类的约束，成为了全局的方法。<code>Kotlin</code>中的<code>Math</code>类也是这样的，相比<code>Java</code>中的<code>Math</code>，调用时可以直接写作<code>min(a, b)</code>，不用加上类名。</p>
<h3 id="内联-inline"><a href="#内联-inline" class="headerlink" title="内联 inline"></a>内联 inline</h3><p>它的作用类似于我们日常中的封装，但是又和我们的封装有些不一样。我们遇到多次出现但是内容一样的代码时，一般都是抽取并且包装成一个方法，如果是多个类共用，那么可能还要再抽取一个类出来，尽管方法实现还是那样的，但是毕竟还是抽了个方法出来，可能还跨了类调用，方法寻址还是需要时间的。<br>而内联的作用与它类似，但是它是反过来的，当编译时，会把内联方法的代码整个复制到调用的地方，然后顺便做一下结构优化，这样就满足了我们的本来目的，一次写多份代码。</p>
<h3 id="reified"><a href="#reified" class="headerlink" title="reified"></a>reified</h3><p>这个关键一般是配合<code>inline</code>使用的，从含义上来讲，是<code>使它更真实</code>，我的理解就是推导泛型。<br>上面讲过了，编译时内联代码是以复制的形式贴到调用的地方的，而这个时候，如果方法存在泛型，那么基本上都是可以直接明确类型的，而这个关键字就是做这个的。<br>它可以避免泛型和类型强转引发的安全隐患，也可以实现另类的重载。</p>
<h3 id="函数引用"><a href="#函数引用" class="headerlink" title="函数引用"></a>函数引用</h3><p>在<code>Kotlin</code>一切函数皆可<code>lambda</code>，可以直接拿到函数的引用，然后在必要时调用，就像上面的<code>run.invoke()</code>。<br>而在使用是，由于表达式的特性，直接使用大括号就好了，也省了很多事情，不用反复申明接口，<code>new</code>对象。<br>甚至，可以通过<code>::</code>来获取对象中的函数引用，只要函数，不要对象，使用和传递过程也少了很多限制。</p>
<h3 id="懒加载"><a href="#懒加载" class="headerlink" title="懒加载"></a>懒加载</h3><p>就是上面申明线程池的那个关键字<code>by lazy</code>，它要求变量必须是<code>val</code>，其实就是帮我们做了在<code>get</code>的时候调用后面的表达式实例化对象，然后后面一直使用这个对象，就像帮我们做了个小单例。</p>
<h2 id="糖衣内的Java"><a href="#糖衣内的Java" class="headerlink" title="糖衣内的Java"></a>糖衣内的Java</h2><p>上面的糖衣看起来是真的很甜啊，可以省略很多代码，大大的提高开发的效率，那么糖衣里面是什么呢？<br>有个方法，在<code>IntelliJ IDEA</code>中，打开一个<code>kt</code>结尾的<code>Kotlin</code>代码文件，然后依次打开菜单中的<code>Tool</code> - <code>Kotlin</code> - <code>Show Kotlin Bytecode</code>。<br>这时，右侧会打开一个窗口，显示这个文件的字节码，再次点击窗口的<code>Decompile</code>按钮，那么就会出现一个将字节码反编译为<code>Java</code>的窗口了。<br>我们以此来了解一下<code>语法糖</code>帮我们做了什么？</p>
<h3 id="顶级函数-1"><a href="#顶级函数-1" class="headerlink" title="顶级函数"></a>顶级函数</h3><p>首先，我们先写一个文件，名字就叫做<code>Test.kt</code>，里面放一个顶级函数，就像这样</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> lollipop.test</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">sayHello</span><span class="params">()</span></span> &#123;</span><br><span class="line">    print(<span class="string">"Hello"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后我们按照上面的方法，反编译一下。然后就得到了这样的一个<code>Java</code>类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> lollipop.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> kotlin.Metadata;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Metadata</span>(</span><br><span class="line">   mv = &#123;<span class="number">1</span>, <span class="number">1</span>, <span class="number">16</span>&#125;,</span><br><span class="line">   bv = &#123;<span class="number">1</span>, <span class="number">0</span>, <span class="number">3</span>&#125;,</span><br><span class="line">   k = <span class="number">2</span>,</span><br><span class="line">   d1 = &#123;<span class="string">"\u0000\b\n\u0000\n\u0002\u0010\u0002\n\u0000\u001a\u0006\u0010\u0000\u001a\u00020\u0001¨\u0006\u0002"</span>&#125;,</span><br><span class="line">   d2 = &#123;<span class="string">"sayHello"</span>, <span class="string">""</span>, <span class="string">"HelloWorld"</span>&#125;</span><br><span class="line">)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TestKt</span> </span>&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      String var0 = <span class="string">"Hello"</span>;</span><br><span class="line">      <span class="keyword">boolean</span> var1 = <span class="keyword">false</span>;</span><br><span class="line">      System.out.print(var0);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后我们找一下不同，看看它帮我们做了什么。</p>
<ol>
<li>它帮我们声明了一个类，类名就是文件名然后加上<code>Kt</code>后缀，我们都知道，<code>Java</code>要求每一个<code>Java</code>文件都需要有一个与文件名同名的且为<code>public</code>的类，显然它帮我们做了这件事。</li>
<li>类名和方法自动加上了<code>final</code>，这也是<code>Kotlin</code>在不加<code>open</code>时不能被继承和重写的原因。</li>
<li><code>sayHello</code>方法本来是写在外面的，现在它帮我们放在了类中，同时加上了<code>static</code>，说明它是一个可以直接使用的方法。</li>
</ol>
<p>那么顶级函数就是一个静态方法吗？我们再去使用的地方验证一下。<br>我们创建两个文件，一个是<code>Test.java</code>，另一个是<code>Test2.kt</code>。<br>然后我们先看看在<code>Java</code>中的调用.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> lollipop.test;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Test</span><span class="params">(String value)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">with</span><span class="params">(<span class="keyword">int</span> value)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        TestKt.sayHello();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>经过一番尝试，发现需要按照我们刚刚反编译的方式调用，<br>那么<code>Kotlin</code>里面的调用呢？</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> lollipop.test</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">world</span><span class="params">()</span></span> &#123;</span><br><span class="line">    </span><br><span class="line">        sayHello()</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里很简单，就像本来就有这个方法一样，直接使用，看起来很舒服，那么它实际上是什么呢？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> lollipop.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> kotlin.Metadata;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Metadata</span>(</span><br><span class="line">   mv = &#123;<span class="number">1</span>, <span class="number">1</span>, <span class="number">16</span>&#125;,</span><br><span class="line">   bv = &#123;<span class="number">1</span>, <span class="number">0</span>, <span class="number">3</span>&#125;,</span><br><span class="line">   k = <span class="number">1</span>,</span><br><span class="line">   d1 = &#123;<span class="string">"\u0000\u0012\n\u0002\u0018\u0002\n\u0002\u0010\u0000\n\u0002\b\u0002\n\u0002\u0010\u0002\n\u0000\u0018\u00002\u00020\u0001B\u0005¢\u0006\u0002\u0010\u0002J\u0006\u0010\u0003\u001a\u00020\u0004¨\u0006\u0005"</span>&#125;,</span><br><span class="line">   d2 = &#123;<span class="string">"Llollipop/test/Test2;"</span>, <span class="string">""</span>, <span class="string">"()V"</span>, <span class="string">"world"</span>, <span class="string">""</span>, <span class="string">"HelloWorld"</span>&#125;</span><br><span class="line">)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Test2</span> </span>&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">world</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      TestKt.sayHello();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实际上和我们手写的<code>Java</code>类是一样的调用。</p>
<h3 id="伴生对象"><a href="#伴生对象" class="headerlink" title="伴生对象"></a>伴生对象</h3><p>我们都知道，在写<code>kotlin</code>时，要在一个类中写一些静态方法时，一般都是写在<code>companion object</code>中，中文翻译就是<code>伴随对象</code>。那么它和我们的静态方法有什么关系和区别呢？<br>首先，我们就用上面的<code>Test2.kt</code>加一点代码看看。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> lollipop.test</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">val</span> NAME = <span class="string">"Test2"</span></span><br><span class="line">        <span class="keyword">val</span> pre = <span class="string">"I am"</span></span><br><span class="line">        <span class="keyword">var</span> id = <span class="number">0</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">var</span> id2 = <span class="number">1</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">var</span> id3 = <span class="number">2</span></span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">name</span><span class="params">(n: <span class="type">String</span>)</span></span>: String &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"Hey <span class="variable">$n</span>, <span class="variable">$pre</span> <span class="variable">$NAME</span>, id is <span class="variable">$id</span>-<span class="variable">$id2</span>"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">world</span><span class="params">()</span></span> &#123;</span><br><span class="line">        id = <span class="number">1</span></span><br><span class="line">        sayHello()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在是这样，为了做对比，我加了三个变量一个方法，分别用不同的关键字。<br>现在我们来看看它的反编译结果。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> lollipop.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> kotlin.Metadata;</span><br><span class="line"><span class="keyword">import</span> kotlin.jvm.internal.DefaultConstructorMarker;</span><br><span class="line"><span class="keyword">import</span> kotlin.jvm.internal.Intrinsics;</span><br><span class="line"><span class="keyword">import</span> org.jetbrains.annotations.NotNull;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Metadata</span>(</span><br><span class="line">   mv = &#123;<span class="number">1</span>, <span class="number">1</span>, <span class="number">16</span>&#125;,</span><br><span class="line">   bv = &#123;<span class="number">1</span>, <span class="number">0</span>, <span class="number">3</span>&#125;,</span><br><span class="line">   k = <span class="number">1</span>,</span><br><span class="line">   d1 = &#123;<span class="string">"\u0000\u0014\n\u0002\u0018\u0002\n\u0002\u0010\u0000\n\u0002\b\u0002\n\u0002\u0010\u0002\n\u0002\b\u0002\u0018\u0000 \u00052\u00020\u0001:\u0001\u0005B\u0005¢\u0006\u0002\u0010\u0002J\u0006\u0010\u0003\u001a\u00020\u0004¨\u0006\u0006"</span>&#125;,</span><br><span class="line">   d2 = &#123;<span class="string">"Llollipop/test/Test2;"</span>, <span class="string">""</span>, <span class="string">"()V"</span>, <span class="string">"world"</span>, <span class="string">""</span>, <span class="string">"Companion"</span>, <span class="string">"HelloWorld"</span>&#125;</span><br><span class="line">)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Test2</span> </span>&#123;</span><br><span class="line">   <span class="meta">@NotNull</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String NAME = <span class="string">"Test2"</span>;</span><br><span class="line">   <span class="meta">@NotNull</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String pre = <span class="string">"I am"</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> id;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> id2 = <span class="number">1</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> id3 = <span class="number">2</span>;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Test2.Companion Companion = <span class="keyword">new</span> Test2.Companion((DefaultConstructorMarker)<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">world</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      id = <span class="number">1</span>;</span><br><span class="line">      TestKt.sayHello();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// $FF: synthetic method</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> access$setId2$cp(<span class="keyword">int</span> var0) &#123;</span><br><span class="line">      id2 = var0;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Metadata</span>(</span><br><span class="line">      mv = &#123;<span class="number">1</span>, <span class="number">1</span>, <span class="number">16</span>&#125;,</span><br><span class="line">      bv = &#123;<span class="number">1</span>, <span class="number">0</span>, <span class="number">3</span>&#125;,</span><br><span class="line">      k = <span class="number">1</span>,</span><br><span class="line">      d1 = &#123;<span class="string">"\u0000\u001a\n\u0002\u0018\u0002\n\u0002\u0010\u0000\n\u0002\b\u0002\n\u0002\u0010\u000e\n\u0000\n\u0002\u0010\b\n\u0002\b\f\b\u0086\u0003\u0018\u00002\u00020\u0001B\u0007\b\u0002¢\u0006\u0002\u0010\u0002J\u000e\u0010\u0010\u001a\u00020\u00042\u0006\u0010\u0011\u001a\u00020\u0004R\u000e\u0010\u0003\u001a\u00020\u0004X\u0086T¢\u0006\u0002\n\u0000R\u001a\u0010\u0005\u001a\u00020\u0006X\u0086\u000e¢\u0006\u000e\n\u0000\u001a\u0004\b\u0007\u0010\b\"\u0004\b\t\u0010\nR\u000e\u0010\u000b\u001a\u00020\u0006X\u0082\u000e¢\u0006\u0002\n\u0000R\u000e\u0010\f\u001a\u00020\u0006X\u0082\u000e¢\u0006\u0002\n\u0000R\u0014\u0010\r\u001a\u00020\u0004X\u0086D¢\u0006\b\n\u0000\u001a\u0004\b\u000e\u0010\u000f¨\u0006\u0012"</span>&#125;,</span><br><span class="line">      d2 = &#123;<span class="string">"Llollipop/test/Test2$Companion;"</span>, <span class="string">""</span>, <span class="string">"()V"</span>, <span class="string">"NAME"</span>, <span class="string">""</span>, <span class="string">"id"</span>, <span class="string">""</span>, <span class="string">"getId"</span>, <span class="string">"()I"</span>, <span class="string">"setId"</span>, <span class="string">"(I)V"</span>, <span class="string">"id2"</span>, <span class="string">"id3"</span>, <span class="string">"pre"</span>, <span class="string">"getPre"</span>, <span class="string">"()Ljava/lang/String;"</span>, <span class="string">"name"</span>, <span class="string">"n"</span>, <span class="string">"HelloWorld"</span>&#125;</span><br><span class="line">   )</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Companion</span> </span>&#123;</span><br><span class="line">      <span class="meta">@NotNull</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> String <span class="title">getPre</span><span class="params">()</span> </span>&#123;</span><br><span class="line">         <span class="keyword">return</span> Test2.pre;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">         <span class="keyword">return</span> Test2.id;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(<span class="keyword">int</span> var1)</span> </span>&#123;</span><br><span class="line">         Test2.id = var1;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@NotNull</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> String <span class="title">name</span><span class="params">(@NotNull String n)</span> </span>&#123;</span><br><span class="line">         Intrinsics.checkParameterIsNotNull(n, <span class="string">"n"</span>);</span><br><span class="line">         <span class="keyword">return</span> <span class="string">"Hey "</span> + n + <span class="string">", "</span> + ((Test2.Companion)<span class="keyword">this</span>).getPre() + <span class="string">" Test2, id is "</span> + ((Test2.Companion)<span class="keyword">this</span>).getId() + <span class="string">'-'</span> + Test2.id2;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">private</span> <span class="title">Companion</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// $FF: synthetic method</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="title">Companion</span><span class="params">(DefaultConstructorMarker $constructor_marker)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">this</span>();</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们一个个的看。</p>
<ol>
<li>生成了一个叫做<code>Companion</code>的内部类，它是静态的，并且提供了一系列方法。它应该就是我们的伴生对象了。</li>
<li><code>Companion</code>类在主类中有一个实例，它是同时被<code>static final</code>修饰的，<code>Kotlin</code>中没有静态修饰符，因此它一定程度上就代表了<code>Kotlin</code>的静态方法区和静态变量区。</li>
<li><code>const</code>修饰的<code>NAME</code>变成了一个常量，前面是<code>public</code>，是一个标准的常量。</li>
<li>而只是少了个<code>const</code>的<code>pre</code>却是<code>private</code>，但是在伴生对象中提供了一个<code>getPre</code>方法，说明<code>const</code>关键字是用来声明<code>真·常量</code>。</li>
<li><code>id</code>初始化为0，但是在反编译代码中没有看到初始化为0的代码。</li>
<li>被<code>private</code>修饰的其他几个变量，没有提供<code>getter</code>方法。</li>
<li>所有声明在伴生对象中的变量对外接口几乎都是通过伴生对象，但是实际都是在主类中保存为静态的。</li>
<li>伴生对象中的方法，最后会在生成的伴生类中，并且是静态方法。</li>
<li>字符串最后生成结果仍然是用<code>+</code>拼接的，而变量的使用，对于有提供<code>getter</code>方法的，会使用<code>getter</code>方法。</li>
</ol>
<h3 id="函数引用-1"><a href="#函数引用-1" class="headerlink" title="函数引用"></a>函数引用</h3><p>函数式编程是<code>Kotlin</code>的一大特色，这次我们看看它怎么包装的。<br>这次因为涉及函数的互相调用，所以改了改上面的三个类，改成了这样：<br>Test.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> lollipop.test;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">say</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        TestKt.sayHello();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Test.kt</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> lollipop.test</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">sayHello</span><span class="params">()</span></span> &#123;</span><br><span class="line">    print(<span class="string">"Hello"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">add</span><span class="params">(num: () -&gt; <span class="type">Int</span>)</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> num() + num.invoke()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">textSay</span><span class="params">(run: () -&gt; <span class="type">Unit</span>)</span></span> &#123;</span><br><span class="line">    run.invoke()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Test2.kt</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> lollipop.test</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.*</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">world</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> random = Random()</span><br><span class="line">        <span class="keyword">val</span> value = add &#123; random.nextInt() &#125;</span><br><span class="line">        textSay(Test::say)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Java</code>类没什么好看的，我们直接看后面的，<code>Test.kt</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> lollipop.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> kotlin.Metadata;</span><br><span class="line"><span class="keyword">import</span> kotlin.jvm.functions.Function0;</span><br><span class="line"><span class="keyword">import</span> kotlin.jvm.internal.Intrinsics;</span><br><span class="line"><span class="keyword">import</span> org.jetbrains.annotations.NotNull;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Metadata</span>(</span><br><span class="line">   mv = &#123;<span class="number">1</span>, <span class="number">1</span>, <span class="number">16</span>&#125;,</span><br><span class="line">   bv = &#123;<span class="number">1</span>, <span class="number">0</span>, <span class="number">3</span>&#125;,</span><br><span class="line">   k = <span class="number">2</span>,</span><br><span class="line">   d1 = &#123;<span class="string">"\u0000\u0016\n\u0000\n\u0002\u0010\b\n\u0000\n\u0002\u0018\u0002\n\u0000\n\u0002\u0010\u0002\n\u0002\b\u0003\u001a\u0014\u0010\u0000\u001a\u00020\u00012\f\u0010\u0002\u001a\b\u0012\u0004\u0012\u00020\u00010\u0003\u001a\u0006\u0010\u0004\u001a\u00020\u0005\u001a\u0014\u0010\u0006\u001a\u00020\u00052\f\u0010\u0007\u001a\b\u0012\u0004\u0012\u00020\u00050\u0003¨\u0006\b"</span>&#125;,</span><br><span class="line">   d2 = &#123;<span class="string">"add"</span>, <span class="string">""</span>, <span class="string">"num"</span>, <span class="string">"Lkotlin/Function0;"</span>, <span class="string">"sayHello"</span>, <span class="string">""</span>, <span class="string">"textSay"</span>, <span class="string">"run"</span>, <span class="string">"HelloWorld"</span>&#125;</span><br><span class="line">)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TestKt</span> </span>&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      String var0 = <span class="string">"Hello"</span>;</span><br><span class="line">      <span class="keyword">boolean</span> var1 = <span class="keyword">false</span>;</span><br><span class="line">      System.out.print(var0);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">add</span><span class="params">(@NotNull Function0 num)</span> </span>&#123;</span><br><span class="line">      Intrinsics.checkParameterIsNotNull(num, <span class="string">"num"</span>);</span><br><span class="line">      <span class="keyword">return</span> ((Number)num.invoke()).intValue() + ((Number)num.invoke()).intValue();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">textSay</span><span class="params">(@NotNull Function0 run)</span> </span>&#123;</span><br><span class="line">      Intrinsics.checkParameterIsNotNull(run, <span class="string">"run"</span>);</span><br><span class="line">      run.invoke();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，我们声明的<code>函数</code>，现在变成了一个叫做<code>Function0</code>的类，其他的都没变，方法内使用的是<code>Function0</code>的<code>invoke</code>方法，让我们看看这个类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> kotlin.jvm.functions</span><br><span class="line"></span><br><span class="line"><span class="comment">/** A function that takes 0 arguments. */</span></span><br><span class="line">public interface Function0&lt;out R&gt; : Function&lt;R&gt; &#123;</span><br><span class="line">    <span class="comment">/** Invokes the function. */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> operator fun <span class="title">invoke</span><span class="params">()</span>: R</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"><span class="comment">/** A function that takes 1 argument. */</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> interface Function1&lt;in P1, out R&gt; : Function&lt;R&gt; </span>&#123;</span><br><span class="line">    <span class="comment">/** Invokes the function with the specified argument. */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> operator fun <span class="title">invoke</span><span class="params">(p1: P1)</span>: R</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"><span class="comment">/** A function that takes 2 arguments. */</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> interface Function2&lt;in P1, in P2, out R&gt; : Function&lt;R&gt; </span>&#123;</span><br><span class="line">    <span class="comment">/** Invokes the function with the specified arguments. */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> operator fun <span class="title">invoke</span><span class="params">(p1: P1, p2: P2)</span>: R</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"> <span class="comment">// ...省略中间的多个接口</span></span></span><br><span class="line"><span class="function"><span class="comment">/** A function that takes 22 arguments. */</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> interface Function22&lt;in P1, in P2, in P3, in P4, in P5, in P6, in P7, in P8, in P9, in P10, in P11, in P12, in P13, in P14, in P15, in P16, in P17, in P18, in P19, in P20, in P21, in P22, out R&gt; : Function&lt;R&gt; </span>&#123;</span><br><span class="line">    <span class="comment">/** Invokes the function with the specified arguments. */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> operator fun <span class="title">invoke</span><span class="params">(p1: P1, p2: P2, p3: P3, p4: P4, p5: P5, p6: P6, p7: P7, p8: P8, p9: P9, p10: P10, p11: P11, p12: P12, p13: P13, p14: P14, p15: P15, p16: P16, p17: P17, p18: P18, p19: P19, p20: P20, p21: P21, p22: P22)</span>: R</span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure>
<p>可以看到，这是跳转到了<code>Koltin</code>标准库中的一个文件，它声明了非常多的方法，最多是到了22个参数，每个都有自己的范型，而刚刚的<code>Function0</code>就是无参数的接口。所以其实就是它帮我们写好了很多通用接口，然后回调触发？<br>那么问题来了，如果我超过22个呢？</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">args</span><span class="params">(num: (<span class="type">Int</span>, <span class="type">String</span>, <span class="type">Float</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">               <span class="type">Int</span>, <span class="type">String</span>, <span class="type">Float</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">               <span class="type">Int</span>, <span class="type">String</span>, <span class="type">Float</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">               <span class="type">Int</span>, <span class="type">String</span>, <span class="type">Float</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">               <span class="type">Int</span>, <span class="type">String</span>, <span class="type">Float</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">               <span class="type">Int</span>, <span class="type">String</span>, <span class="type">Float</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">               <span class="type">Int</span>, <span class="type">String</span>, <span class="type">Float</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">               <span class="type">Int</span>, <span class="type">String</span>, <span class="type">Float</span>) -&gt; <span class="type">Int</span>)</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>于是我加了上面的这个方法，24个参数，看看它做了啥。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">args</span><span class="params">(@NotNull FunctionN num)</span> </span>&#123;</span><br><span class="line">   Intrinsics.checkParameterIsNotNull(num, <span class="string">"num"</span>);</span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果是这样的，(///▽///)，所以它是知道有我们这种流氓，所以干脆弄个<code>N</code>的出来呗？<br>那么这个<code>FunctionN</code>里面是啥呢？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">interface FunctionN&lt;out R&gt; : Function&lt;R&gt;, FunctionBase&lt;R&gt; &#123;</span><br><span class="line">    <span class="function">operator fun <span class="title">invoke</span><span class="params">(vararg args: Any?)</span>: R</span></span><br><span class="line"><span class="function">    override val arity: Int</span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure>
<p>emmm，构建者给出长度，然后参数全放数组里面，一了百了了。</p>
<p>行，那么我们再看看<code>Test2.kt</code>，看看调用的地方怎么样的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> lollipop.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"><span class="keyword">import</span> kotlin.Metadata;</span><br><span class="line"><span class="keyword">import</span> kotlin.jvm.functions.Function0;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Metadata</span>(</span><br><span class="line">   mv = &#123;<span class="number">1</span>, <span class="number">1</span>, <span class="number">16</span>&#125;,</span><br><span class="line">   bv = &#123;<span class="number">1</span>, <span class="number">0</span>, <span class="number">3</span>&#125;,</span><br><span class="line">   k = <span class="number">1</span>,</span><br><span class="line">   d1 = &#123;<span class="string">"\u0000\u0012\n\u0002\u0018\u0002\n\u0002\u0010\u0000\n\u0002\b\u0002\n\u0002\u0010\u0002\n\u0000\u0018\u00002\u00020\u0001B\u0005¢\u0006\u0002\u0010\u0002J\u0006\u0010\u0003\u001a\u00020\u0004¨\u0006\u0005"</span>&#125;,</span><br><span class="line">   d2 = &#123;<span class="string">"Llollipop/test/Test2;"</span>, <span class="string">""</span>, <span class="string">"()V"</span>, <span class="string">"world"</span>, <span class="string">""</span>, <span class="string">"HelloWorld"</span>&#125;</span><br><span class="line">)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Test2</span> </span>&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">world</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">final</span> Random random = <span class="keyword">new</span> Random();</span><br><span class="line">      <span class="keyword">int</span> value = TestKt.add((Function0)(<span class="keyword">new</span> Function0() &#123;</span><br><span class="line">         <span class="comment">// $FF: synthetic method</span></span><br><span class="line">         <span class="comment">// $FF: bridge method</span></span><br><span class="line">         <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.invoke();</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">invoke</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> random.nextInt();</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;));</span><br><span class="line">      TestKt.textSay((Function0)<span class="keyword">null</span>.INSTANCE);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先是<code>add</code>方法，不出所料的是创建了一个匿名内部类，但是里面的写法很有意思，它先是实现一个<code>final</code>的方法，返回值是<code>int</code>的，来包裹我们的业务代码，然后另一个再去调用它。所以推测返回<code>Object</code>的方法才是接口的真正方法，这样做的原因推测是跟范型擦除有点关系吧。（瞎猜的）</p>
<p>而另一个方法就很奇怪了，不明白使用<code>Java</code>的函数引用，怎么就反编译成了这样。为了验证，我又改成了<code>Kotlin</code>的方法传了进去。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> lollipop.test</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.*</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">world</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> random = Random()</span><br><span class="line">        <span class="keyword">val</span> value = add &#123; random.nextInt() &#125;</span><br><span class="line">        textSay(<span class="keyword">this</span>::test)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">test</span><span class="params">()</span></span> &#123;</span><br><span class="line">        sayHello()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> lollipop.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"><span class="keyword">import</span> kotlin.Metadata;</span><br><span class="line"><span class="keyword">import</span> kotlin.Unit;</span><br><span class="line"><span class="keyword">import</span> kotlin.jvm.functions.Function0;</span><br><span class="line"><span class="keyword">import</span> kotlin.jvm.internal.Reflection;</span><br><span class="line"><span class="keyword">import</span> kotlin.reflect.KDeclarationContainer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Metadata</span>(</span><br><span class="line">   mv = &#123;<span class="number">1</span>, <span class="number">1</span>, <span class="number">16</span>&#125;,</span><br><span class="line">   bv = &#123;<span class="number">1</span>, <span class="number">0</span>, <span class="number">3</span>&#125;,</span><br><span class="line">   k = <span class="number">1</span>,</span><br><span class="line">   d1 = &#123;<span class="string">"\u0000\u0014\n\u0002\u0018\u0002\n\u0002\u0010\u0000\n\u0002\b\u0002\n\u0002\u0010\u0002\n\u0002\b\u0002\u0018\u00002\u00020\u0001B\u0005¢\u0006\u0002\u0010\u0002J\u0006\u0010\u0003\u001a\u00020\u0004J\u0006\u0010\u0005\u001a\u00020\u0004¨\u0006\u0006"</span>&#125;,</span><br><span class="line">   d2 = &#123;<span class="string">"Llollipop/test/Test2;"</span>, <span class="string">""</span>, <span class="string">"()V"</span>, <span class="string">"test"</span>, <span class="string">""</span>, <span class="string">"world"</span>, <span class="string">"HelloWorld"</span>&#125;</span><br><span class="line">)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Test2</span> </span>&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">world</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">final</span> Random random = <span class="keyword">new</span> Random();</span><br><span class="line">      <span class="keyword">int</span> value = TestKt.add((Function0)(<span class="keyword">new</span> Function0() &#123;</span><br><span class="line">         <span class="comment">// $FF: synthetic method</span></span><br><span class="line">         <span class="comment">// $FF: bridge method</span></span><br><span class="line">         <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.invoke();</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">invoke</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> random.nextInt();</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;));</span><br><span class="line">      TestKt.textSay((Function0)(<span class="keyword">new</span> Function0((Test2)<span class="keyword">this</span>) &#123;</span><br><span class="line">         <span class="comment">// $FF: synthetic method</span></span><br><span class="line">         <span class="comment">// $FF: bridge method</span></span><br><span class="line">         <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.invoke();</span><br><span class="line">            <span class="keyword">return</span> Unit.INSTANCE;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            ((Test2)<span class="keyword">this</span>.receiver).test();</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> KDeclarationContainer <span class="title">getOwner</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> Reflection.getOrCreateKotlinClass(Test2<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"test"</span>;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> String <span class="title">getSignature</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"test()V"</span>;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      TestKt.sayHello();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个结果看起来更加奇怪了，看样子它是做了反射，所以上面我们直接拿<code>Java</code>的方法，应该也是反射了，中间也许出了点问题，不过感觉问题不大。（也许）</p>
<h3 id="扩展函数"><a href="#扩展函数" class="headerlink" title="扩展函数"></a>扩展函数</h3><p>终于说到了扩展函数，<code>Kotlin</code>的标准库中包含了大量的扩展函数，比如最常用的<code>apply</code>和<code>let</code>。<br>让我们看看他们是怎么样的吧。<br>首先是他们的声明：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@kotlin</span>.<span class="keyword">internal</span>.InlineOnly</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T, R&gt;</span> T.<span class="title">let</span><span class="params">(block: (<span class="type">T</span>) -&gt; <span class="type">R</span>)</span></span>: R &#123;</span><br><span class="line">    contract &#123;</span><br><span class="line">        callsInPlace(block, InvocationKind.EXACTLY_ONCE)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> block(<span class="keyword">this</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@kotlin</span>.<span class="keyword">internal</span>.InlineOnly</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> T.<span class="title">apply</span><span class="params">(block: <span class="type">T</span>.() -&gt; <span class="type">Unit</span>)</span></span>: T &#123;</span><br><span class="line">    contract &#123;</span><br><span class="line">        callsInPlace(block, InvocationKind.EXACTLY_ONCE)</span><br><span class="line">    &#125;</span><br><span class="line">    block()</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个没啥说的，只是返回值有点区别而已，我们看书看重点，看看扩展函数会变成什么吧。<br>代码是这样的：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> lollipop.test</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">test</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="string">"hello"</span>.let &#123;</span><br><span class="line">            print(<span class="string">""</span> + it.length)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="string">"world"</span>.apply &#123;</span><br><span class="line">            print(<span class="string">""</span> + <span class="keyword">this</span>.length)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>反编译后是这样的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> lollipop.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> kotlin.Metadata;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Metadata</span>(</span><br><span class="line">   mv = &#123;<span class="number">1</span>, <span class="number">1</span>, <span class="number">16</span>&#125;,</span><br><span class="line">   bv = &#123;<span class="number">1</span>, <span class="number">0</span>, <span class="number">3</span>&#125;,</span><br><span class="line">   k = <span class="number">1</span>,</span><br><span class="line">   d1 = &#123;<span class="string">"\u0000\u0012\n\u0002\u0018\u0002\n\u0002\u0010\u0000\n\u0002\b\u0002\n\u0002\u0010\u0002\n\u0000\u0018\u00002\u00020\u0001B\u0005¢\u0006\u0002\u0010\u0002J\u0006\u0010\u0003\u001a\u00020\u0004¨\u0006\u0005"</span>&#125;,</span><br><span class="line">   d2 = &#123;<span class="string">"Llollipop/test/Test2;"</span>, <span class="string">""</span>, <span class="string">"()V"</span>, <span class="string">"test"</span>, <span class="string">""</span>, <span class="string">"HelloWorld"</span>&#125;</span><br><span class="line">)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Test2</span> </span>&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      String var1 = <span class="string">"hello"</span>;</span><br><span class="line">      <span class="keyword">boolean</span> var2 = <span class="keyword">false</span>;</span><br><span class="line">      <span class="keyword">boolean</span> var3 = <span class="keyword">false</span>;</span><br><span class="line">      <span class="keyword">int</span> var5 = <span class="keyword">false</span>;</span><br><span class="line">      String var6 = <span class="string">""</span> + var1.length();</span><br><span class="line">      <span class="keyword">boolean</span> var7 = <span class="keyword">false</span>;</span><br><span class="line">      System.out.print(var6);</span><br><span class="line">      var1 = <span class="string">"world"</span>;</span><br><span class="line">      var2 = <span class="keyword">false</span>;</span><br><span class="line">      var3 = <span class="keyword">false</span>;</span><br><span class="line">      var5 = <span class="keyword">false</span>;</span><br><span class="line">      var6 = <span class="string">""</span> + var1.length();</span><br><span class="line">      var7 = <span class="keyword">false</span>;</span><br><span class="line">      System.out.print(var6);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>尽管代码被inline优化过了，但是还是可以看出，它就是把被扩展的对象当作参数使用了。<br>这个可能看起来不明显，我们自己写个试试。<br>我们稍微改改代码：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> lollipop.test</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">test</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> result = <span class="string">"hello"</span>.link(<span class="string">"world"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> String.<span class="title">link</span><span class="params">(value: <span class="type">String</span>)</span></span>: String &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span> + value</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，我们自己声明了一个扩展函数，而且没有<code>inline</code>。那么反编译结果呢？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> lollipop.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> kotlin.Metadata;</span><br><span class="line"><span class="keyword">import</span> org.jetbrains.annotations.NotNull;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Metadata</span>(</span><br><span class="line">   mv = &#123;<span class="number">1</span>, <span class="number">1</span>, <span class="number">16</span>&#125;,</span><br><span class="line">   bv = &#123;<span class="number">1</span>, <span class="number">0</span>, <span class="number">3</span>&#125;,</span><br><span class="line">   k = <span class="number">1</span>,</span><br><span class="line">   d1 = &#123;<span class="string">"\u0000\u001a\n\u0002\u0018\u0002\n\u0002\u0010\u0000\n\u0002\b\u0002\n\u0002\u0010\u0002\n\u0000\n\u0002\u0010\u000e\n\u0002\b\u0002\u0018\u00002\u00020\u0001B\u0005¢\u0006\u0002\u0010\u0002J\u0006\u0010\u0003\u001a\u00020\u0004J\u0014\u0010\u0005\u001a\u00020\u0006*\u00020\u00062\u0006\u0010\u0007\u001a\u00020\u0006H\u0002¨\u0006\b"</span>&#125;,</span><br><span class="line">   d2 = &#123;<span class="string">"Llollipop/test/Test2;"</span>, <span class="string">""</span>, <span class="string">"()V"</span>, <span class="string">"test"</span>, <span class="string">""</span>, <span class="string">"link"</span>, <span class="string">""</span>, <span class="string">"value"</span>, <span class="string">"HelloWorld"</span>&#125;</span><br><span class="line">)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Test2</span> </span>&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      String result = <span class="keyword">this</span>.link(<span class="string">"hello"</span>, <span class="string">"world"</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">final</span> String <span class="title">link</span><span class="params">(@NotNull String $<span class="keyword">this</span>$link, String value)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> $<span class="keyword">this</span>$link + value;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>emmm，这次是真的非常明显了，它就是把被扩展的对象作为第一个参数，传了进去，这样一看，瞬间觉得不神奇了，索然无味啊。<br>PS：不过用起来是真的香。</p>
<h3 id="懒加载-1"><a href="#懒加载-1" class="headerlink" title="懒加载"></a>懒加载</h3><p>接着我们来看看懒加载，懒加载可以一定程度上减少了软件初始化时的爆发式内存消耗，不过它真的是这样吗？它又是怎么实现的呢？我们试试看。<br>我们再改改代码。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> lollipop.test</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.*</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> myRandom: Random <span class="keyword">by</span> lazy &#123;</span><br><span class="line">        Random()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">test</span><span class="params">()</span></span> &#123;</span><br><span class="line">        myRandom.nextInt()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，我们懒加载了一个随机数对象，它会在我们使用的时候再初始化。真的是这样吗？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> lollipop.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"><span class="keyword">import</span> kotlin.Lazy;</span><br><span class="line"><span class="keyword">import</span> kotlin.LazyKt;</span><br><span class="line"><span class="keyword">import</span> kotlin.Metadata;</span><br><span class="line"><span class="keyword">import</span> kotlin.jvm.functions.Function0;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Metadata</span>(</span><br><span class="line">   mv = &#123;<span class="number">1</span>, <span class="number">1</span>, <span class="number">16</span>&#125;,</span><br><span class="line">   bv = &#123;<span class="number">1</span>, <span class="number">0</span>, <span class="number">3</span>&#125;,</span><br><span class="line">   k = <span class="number">1</span>,</span><br><span class="line">   d1 = &#123;<span class="string">"\u0000\u001a\n\u0002\u0018\u0002\n\u0002\u0010\u0000\n\u0002\b\u0002\n\u0002\u0018\u0002\n\u0002\b\u0005\n\u0002\u0010\u0002\n\u0000\u0018\u00002\u00020\u0001B\u0005¢\u0006\u0002\u0010\u0002J\u0006\u0010\t\u001a\u00020\nR\u001b\u0010\u0003\u001a\u00020\u00048BX\u0082\u0084\u0002¢\u0006\f\n\u0004\b\u0007\u0010\b\u001a\u0004\b\u0005\u0010\u0006¨\u0006\u000b"</span>&#125;,</span><br><span class="line">   d2 = &#123;<span class="string">"Llollipop/test/Test2;"</span>, <span class="string">""</span>, <span class="string">"()V"</span>, <span class="string">"myRandom"</span>, <span class="string">"Ljava/util/Random;"</span>, <span class="string">"getMyRandom"</span>, <span class="string">"()Ljava/util/Random;"</span>, <span class="string">"myRandom$delegate"</span>, <span class="string">"Lkotlin/Lazy;"</span>, <span class="string">"test"</span>, <span class="string">""</span>, <span class="string">"HelloWorld"</span>&#125;</span><br><span class="line">)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Test2</span> </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> Lazy myRandom$delegate;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">final</span> Random <span class="title">getMyRandom</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      Lazy var1 = <span class="keyword">this</span>.myRandom$delegate;</span><br><span class="line">      Object var3 = <span class="keyword">null</span>;</span><br><span class="line">      <span class="keyword">boolean</span> var4 = <span class="keyword">false</span>;</span><br><span class="line">      <span class="keyword">return</span> (Random)var1.getValue();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.getMyRandom().nextInt();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">Test2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.myRandom$delegate = LazyKt.lazy((Function0)<span class="keyword">null</span>.INSTANCE);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，最后的类型，声明的是一个叫做<code>Lazy</code>的类型，而获取的时候，是从它那里拿的，而它的初始化，是在构造器中。我们好像猜中了什么。有点似曾相识的感觉啊。<br>首先是<code>Lazy</code>类。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Lazy</span>&lt;<span class="type">out T</span>&gt; </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">val</span> value: T</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> <span class="title">isInitialized</span><span class="params">()</span></span>: <span class="built_in">Boolean</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>emmm，从方法名就有点感觉了，似乎就是那么回事啊。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">SynchronizedLazyImpl</span>&lt;<span class="type">out T</span>&gt;</span>(initializer: () -&gt; T, lock: Any? = <span class="literal">null</span>) : Lazy&lt;T&gt;, Serializable &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> initializer: (() -&gt; T)? = initializer</span><br><span class="line">    <span class="meta">@Volatile</span> <span class="keyword">private</span> <span class="keyword">var</span> _value: Any? = UNINITIALIZED_VALUE</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> lock = lock ?: <span class="keyword">this</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">val</span> value: T</span><br><span class="line">        <span class="keyword">get</span>() &#123;</span><br><span class="line">            <span class="keyword">val</span> _v1 = _value</span><br><span class="line">            <span class="keyword">if</span> (_v1 !== UNINITIALIZED_VALUE) &#123;</span><br><span class="line">                <span class="meta">@Suppress(<span class="meta-string">"UNCHECKED_CAST"</span>)</span></span><br><span class="line">                <span class="keyword">return</span> _v1 <span class="keyword">as</span> T</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> synchronized(lock) &#123;</span><br><span class="line">                <span class="keyword">val</span> _v2 = _value</span><br><span class="line">                <span class="keyword">if</span> (_v2 !== UNINITIALIZED_VALUE) &#123;</span><br><span class="line">                    <span class="meta">@Suppress(<span class="meta-string">"UNCHECKED_CAST"</span>)</span> (_v2 <span class="keyword">as</span> T)</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">val</span> typedValue = initializer!!()</span><br><span class="line">                    _value = typedValue</span><br><span class="line">                    initializer = <span class="literal">null</span></span><br><span class="line">                    typedValue</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">isInitialized</span><span class="params">()</span></span>: <span class="built_in">Boolean</span> = _value !== UNINITIALIZED_VALUE</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">toString</span><span class="params">()</span></span>: String = <span class="keyword">if</span> (isInitialized()) value.toString() <span class="keyword">else</span> <span class="string">"Lazy value not initialized yet."</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">writeReplace</span><span class="params">()</span></span>: Any = InitializedLazyImpl(value)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>没跑了，就是这个了，这不就是我们写<code>单例模式</code>的代码吗？只不过这里用的是<code>懒汉模式</code>。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这里简单的看了下常用的<code>Kotlin</code>的基础使用和基础的<code>Java</code>实现，看起来确实是语法糖，只要合理使用设计模式，一样可以做到这样的效果，可是它有编译器支持，比我们<code>土制</code>的好看啊。<br>所以这里，我还是建议，可以尝试把<code>Kotlin</code>用起来，可以减少一大部分的低级<code>Bug</code>。</p>

            <!--[if lt IE 9]><script>document.createElement('audio');</script><![endif]-->
            <audio id="audio" loop="1" preload="auto" controls="controls" data-autoplay="false">
                <source type="audio/mpeg" src="">
            </audio>
            
                <ul id="audio-list" style="display:none">
                    
                        
                            <li title='0' data-url='http://link.hhtjim.com/163/5146554.mp3'></li>
                        
                    
                        
                            <li title='1' data-url='http://link.hhtjim.com/qq/001faIUs4M2zna.mp3'></li>
                        
                    
                </ul>
            
        </div>
        
    <div id='gitalk-container' class="comment link"
        data-ae='false'
        data-ci='83769e11ad8dee614a88'
        data-cs='3de1ef474db139cd0f47e8769f5afed5db7da651'
        data-r='blogTalk'
        data-o='lollipoppp'
        data-a='lollipoppp'
        data-d='false'
    >查看评论</div>


    </div>
    
        <div class='side'>
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#兼容性"><span class="toc-number">1.</span> <span class="toc-text">兼容性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#版本"><span class="toc-number">1.1.</span> <span class="toc-text">版本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#双向"><span class="toc-number">1.2.</span> <span class="toc-text">双向</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#类型处理"><span class="toc-number">2.</span> <span class="toc-text">类型处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#类型推导"><span class="toc-number">2.1.</span> <span class="toc-text">类型推导</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#非空判断"><span class="toc-number">2.2.</span> <span class="toc-text">非空判断</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#类型非空"><span class="toc-number">2.2.1.</span> <span class="toc-text">类型非空</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#空判定"><span class="toc-number">2.2.2.</span> <span class="toc-text">空判定</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Getter-amp-Setter"><span class="toc-number">3.</span> <span class="toc-text">Getter &amp; Setter</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#扩展方法"><span class="toc-number">4.</span> <span class="toc-text">扩展方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#函数式编程"><span class="toc-number">5.</span> <span class="toc-text">函数式编程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#顶级函数"><span class="toc-number">5.1.</span> <span class="toc-text">顶级函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#内联-inline"><span class="toc-number">5.2.</span> <span class="toc-text">内联 inline</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#reified"><span class="toc-number">5.3.</span> <span class="toc-text">reified</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#函数引用"><span class="toc-number">5.4.</span> <span class="toc-text">函数引用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#懒加载"><span class="toc-number">5.5.</span> <span class="toc-text">懒加载</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#糖衣内的Java"><span class="toc-number">6.</span> <span class="toc-text">糖衣内的Java</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#顶级函数-1"><span class="toc-number">6.1.</span> <span class="toc-text">顶级函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#伴生对象"><span class="toc-number">6.2.</span> <span class="toc-text">伴生对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#函数引用-1"><span class="toc-number">6.3.</span> <span class="toc-text">函数引用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#扩展函数"><span class="toc-number">6.4.</span> <span class="toc-text">扩展函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#懒加载-1"><span class="toc-number">6.5.</span> <span class="toc-text">懒加载</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">7.</span> <span class="toc-text">总结</span></a></li></ol>
        </div>
    
</div>


    </div>
</div>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
<script src="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<script src="//lib.baomitu.com/jquery/1.8.3/jquery.min.js"></script>
<script src="/js/plugin.js"></script>
<script src="/js/diaspora.js"></script>
<link rel="stylesheet" href="/photoswipe/photoswipe.css">
<link rel="stylesheet" href="/photoswipe/default-skin/default-skin.css">
<script src="/photoswipe/photoswipe.min.js"></script>
<script src="/photoswipe/photoswipe-ui-default.min.js"></script>

<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>
    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">
        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <!--  Controls are self-explanatory. Order can be changed. -->
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>



<!-- Google Analytics -->
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-153109857-1', 'auto');
  ga('send', 'pageview');
</script>
<!-- End Google Analytics -->


</html>
